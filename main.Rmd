---
title: "SDS - project"
author: "Matteo Migliarini"
date: "`r Sys.Date()`"
output: html_document
---
```{r imports, include=FALSE}
library(tidyverse)
library(reshape2)
library(viridisLite)
library(LaplacesDemon)
data = read.csv('data/matteo-glasses-edited.csv') %>% 
  select(num_range('X', 1:11)) %>%
  replace(. == 'Yay', 1) %>%
  replace(. == 'Nay', 0) %>% 
  replace(. == '',   NA) %>%
  mutate_all(as.numeric) %>%
  as.matrix()
```

# Data
The data consists in matrix $X$ of $45 \times 11$ observations, where each $X_{ij}$ is either an approval or a rejection of the $i$th judge to the $j$th pair of glasses (items).

Some of these datapoints are missing.

Below a graphical rappresentation of the dataset.
```{r values heatmap, echo=FALSE}
heatmap <- function(melted_data, x='x', y='y', value='value') melted_data %>%
  rename(x = x, y=y, value=value) %>%
  ggplot(aes(x,y, fill=value)) +
  geom_raster() +
  theme_void() + theme(aspect.ratio=1) + scale_fill_viridis_c(limits=c(0,1))

heatmap(melt(data), 'Var2', 'Var1')
```

# Jags
```{r}
library('R2jags')
jags_output_as_df <- function(jags_out) {
  bugs_out = jags_out$BUGSoutput$sims.array
  df = as.data.frame(bugs_out)
  colnames(df) = dimnames(bugs_out)[[3]]
  
  df
}

ITER = 1000
BURNIN = 100

I = nrow(data)
J = ncol(data)
jags_data = list(X = data, I = I, J = J)
obs = melt(data)
colnames(obs) <- c('user', 'item', 'rating')
obs$item <- as.integer(obs$item)
obs$rating <- as.integer(obs$rating)
obs <- obs[complete.cases(obs),]

stan_data = list(I=I, J=J, N = nrow(obs), y = obs$rating, item = obs$item, user = obs$user, psi_0=1, phi_0=1)

```

```{r}
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)

stan(
  file = 'models/dirichlet.stan',
  data = stan_data,
  chains = 1,
  warmup = BURNIN,
  iter = ITER,
  
  
)
```


## Dirichlet 
We model both the judges' attitude and the items' quality with a Dirichlet distribution.

```{r echo=FALSE}
system('cat models/dirichlet.txt')
```


```{r}
M = 1/sqrt(sum(data, na.rm=T))

s <- Vectorize(function(a,size=46) 
  rep(a,size) %>%
  rdirichlet(1000, .) %>%
  apply(1, max) %>% ifelse(.<M/2) %>% mean)

tibble(x=seq(1,30, length=100)) %>%
  mutate(y=s(x, size=46)) %>%
  ggplot(aes(x=x,y=y)) +
  geom_line()
```


```{r}
init.dir = list(init1 = list(psi=rep(1/J, J), phi=rep(1/I, I)))

jags.dir = jags(jags_data,
     model.file = 'models/dirichlet.txt',
     n.iter = ITER + BURNIN,
     n.burnin = BURNIN,
     inits = init.dir,
     n.chains = length(init.dir),
     parameters.to.save = c('psi', 'phi', 'theta'),
)
```


```{r}
get_theta_grid <- function(data) data %>%
  select(starts_with('theta')) %>%
  melt() %>%
  group_by(variable) %>%
  summarise(value = median(value)) %>%
  mutate(
    y=sub("theta\\[(\\d+),\\d+\\]", "\\1", variable) %>% as.numeric,
    x=sub("theta\\[\\d+,(\\d+)\\]", "\\1", variable) %>% as.numeric,
  )

dir.mcmc %>%
  get_theta_grid() %>%
  heatmap()
```

```{r}
jags_output_as_df(jags.dir) %>%
  select(starts_with('psi[5]')) %>%
  melt() %>%
  rowid_to_column("index") %>%
  ggplot(aes(x=index,y = value)) +
  geom_line()
```

SOME VALUES ARE OVER 1, THAT'S STRANGE
```{r}
t = jags_output_as_df(jags.dir) %>%
  select(starts_with('theta')) %>%
  melt() %>%
  mutate(
    x=sub("theta\\[(\\d+),\\d+\\]", "\\1", variable) %>% as.numeric,
    y=sub("theta\\[\\d+,(\\d+)\\]", "\\1", variable) %>% as.numeric,
  )

sum(t$value > 1)
```

```{r}
get_vector_variable <- function(data, var) data%>%
  select(starts_with('psi')) %>%
  melt() %>%
  mutate(
    variable=sub('\\w+\\[(\\d+).*', '\\1', variable) %>% as.numeric
  )

dir.mcmc %>%
  get_vector_variable('psi') %>%
  ggplot(aes(x=variable, group=variable, y = value)) +
  geom_boxplot()
  
```

